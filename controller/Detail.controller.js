sap.ui.define(["sap/ui/core/mvc/Controller","./BaseController","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/model/FilterOperator"],function(e,t,a,i,o){"use strict";return t.extend("alfa.com.co.zui5_gestioncotizaciones.controller.Detail",{onInit:function(){this.getRouter().getRoute("Detail").attachPatternMatched(this._onRoutedMatched,this)},_onRoutedMatched:function(){var e=this.getModel().createKey("/CotizacionSet",{Vbeln:this.getModel("detail").getProperty("/Vbeln")});this.getView().setBusy(true);var t=this.getODataManager().getDataPromise("",e,[]),a=new i("Cotizacion",o.EQ,this.getModel("detail").getProperty("/Vbeln")),s=this.getODataManager().getDataPromise("","/ActividadesSet",[a]);Promise.all([t,s]).then(e=>{this.getModel("detail").setProperty("/",e[0]);var t=e[1].results.sort((e,t)=>e.Id>t.Id?1:t.Id>e.Id?-1:0);this.getModel("detail").setProperty("/Activities",t);this.getView().setBusy(false)}).catch(e=>{this.getView().setBusy(false);console.log(e)})},onAddActivity:function(){var e={Id:"0",Cotizacion:this.getModel("detail").getProperty("/Vbeln"),Fecha:new Date,Hora:new Date,Ultima:"X",Modificado:this.getModel("user").getProperty("/name"),Ultimaact:new Date,Fechaact:new Date,Horaact:new Date};this.getModel("activity").setProperty("/",e);this.getCreateDialog("alfa.com.co.zui5_gestioncotizaciones.view.fragment.createActivity",true).open()},onEdit:function(e){var t=this.getModel("detail").getProperty(e.getSource().getBindingContextPath());if(t.Estado!=="Cerrada"){this.getModel("activity").setProperty("/",t);this.getCreateDialog("alfa.com.co.zui5_gestioncotizaciones.view.fragment.editActivity",true).open()}else{this.getMessageBox().error("La actividad ya esta cerrada y no es posible editarla")}},onEditDate:function(e){var t=this.getModel("detail").getProperty("/");this.getModel("date").setProperty("/",{Vbeln:t.Vbeln,Fechaestimada:t.Fechaestimada,Probabilidad:t.Probabilidad2});this.getCreateDialog("alfa.com.co.zui5_gestioncotizaciones.view.fragment.editDate",true).open()},onSaveDate:function(e){var t=this.getModel("date").getProperty("/"),a=new Date;a.setUTCMonth(t.Fechaestimada.getUTCMonth());a.setUTCDate(t.Fechaestimada.getUTCDate());t.Fechaestimada=a;this.getView().setBusy(true);this.getODataManager().getDataPromise("","/CotizacionUpdSet('"+this.getModel("detail").getProperty("/Vbeln")+"')",[]).then(e=>{this.saveDate("update",t)}).catch(e=>{this.saveDate("create",t)})},saveDate:function(e,t){t.Probabilidad=t.Probabilidad.toString();this.getODataManager().saveData("",t,{success:function(e){this.getCreateDialog("alfa.com.co.zui5_gestioncotizaciones.view.fragment.editDate",false).close();this.getMessageBox().show("Guardado correctamente");var t=this.getModel().createKey("/CotizacionSet",{Vbeln:this.getModel("detail").getProperty("/Vbeln")});var a=this.getModel("detail").getProperty("/Activities");this.getODataManager().getDataPromise("",t,[]).then(e=>{this.getModel("detail").setProperty("/",e);this.getModel("detail").setProperty("/Activities",a);this.getView().setBusy(false);this.getModel().refresh(true)})}.bind(this),error:function(e){this.getView().setBusy(false);this.getMessageBox().error("Ha ocurrido un error al cargar la informaci贸n:"+e.responseText)}.bind(this)},{action:e,sEntity:"/CotizacionUpdSet",sNameId:"Vbeln"},this)},onSave:function(e){var t=this.getModel("activity").getProperty("/"),a=sap.ui.core.format.DateFormat.getDateInstance({pattern:"PThh'H'mm'M'ss'S'"}),s=this.getModel().getProperty("/CotizSet('"+t.Cotizacion+"')");if(t.Fecha<s.Erdat){this.getMessageBox().error("La fecha de la actividad es menor a la creaci贸n de la cotizaci贸n");return}if(!t.Tipoactividad){this.getMessageBox().error("El tipo de actividad no puede estar vacio");return}this.getView().setBusy(true);if(t.Id==="0"){t.Hora=a.format(t.Hora);t.Horaact=a.format(t.Horaact)}else{delete t.__metadata}this.getODataManager().saveData("",t,{success:function(e){this.getCreateDialog("",false).close();this.getMessageBox().show("Guardado correctamente");var t=new i("Cotizacion",o.EQ,this.getModel("detail").getProperty("/Vbeln"));this.getODataManager().getDataPromise("","/ActividadesSet",[t]).then(e=>{this.getModel("detail").setProperty("/Activities",e.results);this.getView().setBusy(false)})}.bind(this),error:function(e){this.getView().setBusy(false);this.getMessageBox().error("Ha ocurrido un error al cargar la informaci贸n:"+e.responseText)}.bind(this)},{action:t.Id==="0"?"create":"update",sEntity:"/ActividadSet",sNameId:"Id"},this)},onClose:function(e){this.getCreateDialog("",false).close()}})});